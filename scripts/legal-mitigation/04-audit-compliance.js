#!/usr/bin/env node
const fs = require('fs');
const glob = require('glob');

const FORBIDDEN_TERMS = [
  /alertas?\s+AML/gi,
  /micro-?fraccionamiento/gi,
  /blanqueo\s+de\s+capitales/gi,
  /evasiÃ³n\s+fiscal/gi,
  /ndrangheta/gi,
  /Porto\s+Carro/gi,
  /La\s+Playa/gi,
  /LavapÃ­s/gi,
];

const FILES_PATTERN = ['app/**/*.{tsx,mdx,md}', 'components/**/*.tsx'];

let findings = { CRITICAL: [] };
let totalFiles = 0;
let cleanFiles = 0;

console.log('ðŸ” Running final compliance audit...\n');

FILES_PATTERN.forEach(pattern => {
  const files = glob.sync(pattern);
  totalFiles += files.length;
  
  files.forEach(filePath => {
    if (!fs.existsSync(filePath)) return;
    const content = fs.readFileSync(filePath, 'utf8');
    let fileClean = true;

    FORBIDDEN_TERMS.forEach(term => {
      const matches = content.match(term);
      if (matches) {
        fileClean = false;
        const lines = content.split('\n');
        matches.forEach(match => {
          const lineNum = lines.findIndex(line => line.includes(match)) + 1;
          const context = lines.slice(Math.max(0, lineNum - 2), lineNum + 1).join('\n');
          
          findings.CRITICAL.push({
            file: filePath,
            line: lineNum,
            term: match,
            context: context
          });
        });
      }
    });

    if (fileClean) cleanFiles++;
  });
});

const score = totalFiles > 0 ? Math.round((cleanFiles / totalFiles) * 100) : 100;
const report = `
# Legal Compliance Audit Report
**Date:** ${new Date().toISOString()}
**Repository:** defcon23

## Summary
- **Files scanned:** ${totalFiles}
- **Clean files:** ${cleanFiles}
- **Compliance score:** ${score}/100
- **Critical findings:** ${findings.CRITICAL.length}

## Status: ${score >= 90 ? 'âœ… PASS' : 'âŒ FAIL'}

${findings.CRITICAL.length > 0 ? `
## âš ï¸ CRITICAL FINDINGS
${findings.CRITICAL.map(f => `
### ${f.file}:${f.line}
**Term:** "${f.term}"
\`\`\`
${f.context}
\`\`\`
`).join('\n')}
` : ''}

## Recommendations
${score < 90 ? `
1. Fix all CRITICAL findings immediately
2. Re-run: npm run audit
` : `
âœ… All checks passed. Ready for production.
`}

---
Generated by: scripts/legal-mitigation/04-audit-compliance.js
`;

fs.mkdirSync('reports', { recursive: true });
const reportPath = `reports/legal-audit-${Date.now()}.md`;
fs.writeFileSync(reportPath, report, 'utf8');

console.log(report);
console.log(`\nðŸ“„ Report saved: ${reportPath}\n`);

process.exit(score >= 90 ? 0 : 1);
